// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

generator py_client {
  provider = "C:/Users/vinay/AppData/Roaming/Python/Python314/Scripts/prisma-client-py.exe"
  interface = "asyncio"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id             String   @id @default(cuid())
  name           String
  currency       String   @default("USD")
  initialBalance Float
  currentBalance Float
  isDefault      Boolean  @default(false)
  trades         Trade[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Strategy {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#2962FF") // For UI tagging
  trades      Trade[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Trade {
  id          String   @id @default(cuid())
  ticker      String
  entryDate   DateTime
  exitDate    DateTime?
  entryPrice  Float?   // Optional for Pending orders until filled
  exitPrice   Float?
  quantity    Float
  direction   String   // "LONG" or "SHORT"
  status      String   // "OPEN", "CLOSED", "PENDING", "CANCELLED"
  
  // Relations
  account     Account  @relation(fields: [accountId], references: [id])
  accountId   String
  strategy    Strategy? @relation(fields: [strategyId], references: [id])
  strategyId  String?

  // Advanced Order Fields
  orderType      String   @default("MARKET") // "MARKET", "LIMIT", "STOP"
  limitPrice     Float?
  stopPrice      Float?   // Trigger price for Stop orders
  
  // Bracket Orders
  stopLoss       Float?
  takeProfit     Float?
  
  pnl         Float?
  fees        Float?
  
  // Advanced Journal Metrics
  risk        Float?   // Intended risk in $
  mae         Float?   // Max Adverse Excursion price
  mfe         Float?   // Max Favorable Excursion price
  duration    Int?     // Duration in seconds
  chartSnapshot String? // URL or path to snapshot

  notes       String?
  tags        Tag[]
  metadata    String?  // Storage for arbitrary JSON metrics (e.g. correlation data)
  
  // Phase 1: Journal Enhancement Relations
  marketCondition MarketCondition?
  tradeEvents     TradeEvent[]
  tradeNotes      Note[]
  tradePlan       TradePlan?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Journal {
  id        String   @id @default(cuid())
  date      DateTime @unique
  content   String
  mood      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id      String    @id @default(cuid())
  name    String    @unique
  trades  Trade[]
  groupId String?
  group   TagGroup? @relation(fields: [groupId], references: [id])
}

model BacktestResult {
  id          String   @id @default(cuid())
  strategy    String
  ticker      String
  timeframe   String
  startDate   DateTime
  endDate     DateTime
  
  totalTrades Int
  winRate     Float
  profitFactor Float
  totalPnl    Float
  
  config      String   // JSON string of strategy config
  trades      String   // JSON string of trade list (or relation to Trade model if we want detailed storage)
  
  createdAt   DateTime @default(now())
}

// ==========================================
// Phase 1: Journal Enhancement Models
// ==========================================

// Market context captured at trade time
model MarketCondition {
  id        String  @id @default(cuid())
  tradeId   String  @unique
  trade     Trade   @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  
  vix       Float?
  vvix      Float?
  atr       Float?
  trend     String? // "TRENDING_UP" | "RANGING" | "TRENDING_DOWN"
  session   String? // "ASIAN" | "EUROPEAN" | "US" | "AFTER_HOURS"
  volume    String? // "LOW" | "NORMAL" | "HIGH"
}

// Economic calendar events
model EconomicEvent {
  id        String   @id @default(cuid())
  datetime  DateTime
  name      String
  impact    String   // "HIGH" | "MEDIUM" | "LOW"
  actual    Float?
  forecast  Float?
  previous  Float?
  
  trades    TradeEvent[]
  
  createdAt DateTime @default(now())
}

// Many-to-many: Trade to EconomicEvent
model TradeEvent {
  tradeId   String
  eventId   String
  trade     Trade         @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  event     EconomicEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@id([tradeId, eventId])
}

// Enhanced notes (trade notes, daily notes, misc notes)
model Note {
  id          String    @id @default(cuid())
  tradeId     String?
  trade       Trade?    @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  date        DateTime? // For day notes (when tradeId is null)
  type        String    @default("trade") // "trade" | "day" | "misc"
  mood        String?   // "BULLISH" | "BEARISH" | "NEUTRAL"
  content     String
  tags        String?
  aiGenerated Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Trade planning (pre-trade plans)
model TradePlan {
  id            String   @id @default(cuid())
  date          DateTime
  instrument    String
  setup         String?
  entryPlan     String?
  exitPlan      String?
  riskPlan      String?
  linkedTradeId String?  @unique
  linkedTrade   Trade?   @relation(fields: [linkedTradeId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Tag groups for multi-category tagging
model TagGroup {
  id    String @id @default(cuid())
  name  String @unique // "mistake" | "setup" | "psychology" | "strategy" | "event"
  color String @default("#6b7280")
  tags  Tag[]
}

model WatchlistGroup {
  id        String          @id @default(cuid())
  name      String          @unique
  isDefault Boolean         @default(false)
  items     WatchlistItem[]
  
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model WatchlistItem {
  id        String         @id @default(cuid())
  symbol    String
  name      String?
  
  groupId   String
  group     WatchlistGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  createdAt DateTime       @default(now())

  @@unique([groupId, symbol])
}

model MarketNews {
  id                  String   @id @default(cuid())
  uuid                String   @unique // Yahoo's UUID
  title               String
  publisher           String
  link                String
  providerPublishTime DateTime // Converted from Unix timestamp
  type                String?
  relatedTickers      String?  // Comma-separated or JSON
  
  createdAt           DateTime @default(now())
}

model ExpectedMove {
  id              Int      @id @default(autoincrement())
  ticker          String
  calculationDate DateTime // The date the calculation targets (e.g. today's date for current expiry view)
  expiryDate      DateTime
  
  price           Float
  straddle        Float
  em365           Float
  em252           Float
  adjEm           Float
  
  manualEm        Float?   // User override/addition
  
  // Extra Metadata
  basis           String?  // JSON string of BasisData
  note            String?  // Information about data source (e.g. "manual", "proxy")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([ticker, calculationDate, expiryDate])
}

model SchwabToken {
  id           String   @id @default("schwab-primary")
  accessToken  String
  refreshToken String
  expiresAt    Int      // Unix timestamp
  idToken      String?
  tokenType    String
  scope        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model HistoricalVolatility {
  id          Int      @id @default(autoincrement())
  ticker      String
  date        DateTime
  iv          Float    // iv_current (Implied Volatility)
  hv          Float?   // hv_current (Historical Volatility)
  
  closePrice  Float?   // Underlying close price (to be filled during ingestion or later)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ticker, date])
  @@index([ticker])
}

model ExpectedMoveHistory {
  id              Int      @id @default(autoincrement())
  ticker          String
  date            DateTime
  closePrice      Float

  // Straddle Data
  straddlePrice   Float?
  emStraddle      Float? // Expected Move based on Straddle (e.g. 0.85 * Straddle)

  // IV Data
  iv365           Float?
  em365           Float?
  iv252           Float?
  em252           Float?

  source          String? // "historical", "manual", "computed"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([ticker, date])
  @@index([ticker])
}
