// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id             String   @id @default(cuid())
  name           String
  currency       String   @default("USD")
  initialBalance Float
  currentBalance Float
  isDefault      Boolean  @default(false)
  trades         Trade[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Strategy {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#2962FF") // For UI tagging
  trades      Trade[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Trade {
  id          String   @id @default(cuid())
  ticker      String
  entryDate   DateTime
  exitDate    DateTime?
  entryPrice  Float?   // Optional for Pending orders until filled
  exitPrice   Float?
  quantity    Float
  direction   String   // "LONG" or "SHORT"
  status      String   // "OPEN", "CLOSED", "PENDING", "CANCELLED"
  
  // Relations
  account     Account  @relation(fields: [accountId], references: [id])
  accountId   String
  strategy    Strategy? @relation(fields: [strategyId], references: [id])
  strategyId  String?

  // Advanced Order Fields
  orderType      String   @default("MARKET") // "MARKET", "LIMIT", "STOP"
  limitPrice     Float?
  stopPrice      Float?   // Trigger price for Stop orders
  
  // Bracket Orders
  stopLoss       Float?
  takeProfit     Float?
  
  pnl         Float?
  fees        Float?
  
  // Advanced Journal Metrics
  risk        Float?   // Intended risk in $
  mae         Float?   // Max Adverse Excursion price
  mfe         Float?   // Max Favorable Excursion price
  duration    Int?     // Duration in seconds
  chartSnapshot String? // URL or path to snapshot

  notes       String?
  tags        Tag[]
  metadata    String?  // Storage for arbitrary JSON metrics (e.g. correlation data)
  
  // Phase 1: Journal Enhancement Relations
  marketCondition MarketCondition?
  tradeEvents     TradeEvent[]
  tradeNotes      Note[]
  tradePlan       TradePlan?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Journal {
  id        String   @id @default(cuid())
  date      DateTime @unique
  content   String
  mood      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id      String    @id @default(cuid())
  name    String    @unique
  trades  Trade[]
  groupId String?
  group   TagGroup? @relation(fields: [groupId], references: [id])
}

model BacktestResult {
  id          String   @id @default(cuid())
  strategy    String
  ticker      String
  timeframe   String
  startDate   DateTime
  endDate     DateTime
  
  totalTrades Int
  winRate     Float
  profitFactor Float
  totalPnl    Float
  
  config      String   // JSON string of strategy config
  trades      String   // JSON string of trade list (or relation to Trade model if we want detailed storage)
  
  createdAt   DateTime @default(now())
}

// ==========================================
// Phase 1: Journal Enhancement Models
// ==========================================

// Market context captured at trade time
model MarketCondition {
  id        String  @id @default(cuid())
  tradeId   String  @unique
  trade     Trade   @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  
  vix       Float?
  vvix      Float?
  atr       Float?
  trend     String? // "TRENDING_UP" | "RANGING" | "TRENDING_DOWN"
  session   String? // "ASIAN" | "EUROPEAN" | "US" | "AFTER_HOURS"
  volume    String? // "LOW" | "NORMAL" | "HIGH"
}

// Economic calendar events
model EconomicEvent {
  id        String   @id @default(cuid())
  datetime  DateTime
  name      String
  impact    String   // "HIGH" | "MEDIUM" | "LOW"
  actual    Float?
  forecast  Float?
  previous  Float?
  
  trades    TradeEvent[]
  
  createdAt DateTime @default(now())
}

// Many-to-many: Trade to EconomicEvent
model TradeEvent {
  tradeId   String
  eventId   String
  trade     Trade         @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  event     EconomicEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@id([tradeId, eventId])
}

// Enhanced notes (trade notes, daily notes, misc notes)
model Note {
  id          String    @id @default(cuid())
  tradeId     String?
  trade       Trade?    @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  date        DateTime? // For day notes (when tradeId is null)
  type        String    @default("trade") // "trade" | "day" | "misc"
  mood        String?   // "BULLISH" | "BEARISH" | "NEUTRAL"
  content     String
  tags        String?
  aiGenerated Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Trade planning (pre-trade plans)
model TradePlan {
  id            String   @id @default(cuid())
  date          DateTime
  instrument    String
  setup         String?
  entryPlan     String?
  exitPlan      String?
  riskPlan      String?
  linkedTradeId String?  @unique
  linkedTrade   Trade?   @relation(fields: [linkedTradeId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Tag groups for multi-category tagging
model TagGroup {
  id    String @id @default(cuid())
  name  String @unique // "mistake" | "setup" | "psychology" | "strategy" | "event"
  color String @default("#6b7280")
  tags  Tag[]
}
