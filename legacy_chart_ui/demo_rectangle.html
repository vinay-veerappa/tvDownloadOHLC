<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Demo: Rectangle Tool</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            background: #1e222d;
            color: #d1d4dc;
            font-family: sans-serif;
        }

        #toolbar {
            background: #2a2e39;
            padding: 10px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #3a3e49;
            align-items: center;
        }

        button {
            background: #3a3e49;
            color: #d1d4dc;
            border: 1px solid #4a4e59;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #4a4e59;
        }

        button.active {
            background: #2962FF;
            border-color: #2962FF;
        }

        #chart {
            width: 100%;
            height: calc(100vh - 60px);
            position: relative;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <button id="btn-rect" onclick="toggleRectTool()">â–­ Draw Rectangle</button>
        <button onclick="clearRects()">ðŸ—‘ Clear</button>
        <div style="font-size:12px; color:#888; margin-left:auto">HTML Overlay Demo</div>
    </div>
    <div id="chart"></div>
    <script>
        // 1. Initialize Chart
        const chart = window.LightweightCharts.createChart(document.getElementById('chart'), {
            width: window.innerWidth,
            height: window.innerHeight - 60,
            layout: { background: { color: '#1e222d' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
            timeScale: { timeVisible: true },
        });

        const series = chart.addSeries(window.LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a', downColor: '#ef5350',
            wickUpColor: '#26a69a', wickDownColor: '#ef5350'
        });

        // 2. Load Data
        fetch('http://localhost:8000/api/ohlc/1h?limit=1000')
            .then(r => r.json())
            .then(data => {
                if (data.data) {
                    series.setData(data.data);
                    chart.timeScale().fitContent();
                }
            });

        // 3. Rectangle Tool Logic (HTML Overlay)
        let isDrawing = false;
        let startPoint = null;
        let activeBox = null;

        function toggleRectTool() {
            isDrawing = !isDrawing;
            document.getElementById('btn-rect').classList.toggle('active', isDrawing);
            document.body.style.cursor = isDrawing ? 'crosshair' : 'default';
        }

        const chartContainer = document.getElementById('chart');
        const overlay = document.createElement('div');
        overlay.style.position = 'absolute';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.pointerEvents = 'none';
        chartContainer.appendChild(overlay);

        chart.subscribeClick((param) => {
            if (!isDrawing || !param.point) return;

            if (!startPoint) {
                // Start Drawing
                startPoint = { x: param.point.x, y: param.point.y };

                activeBox = document.createElement('div');
                activeBox.style.position = 'absolute';
                activeBox.style.border = '2px solid #2196F3';
                activeBox.style.backgroundColor = 'rgba(33, 150, 243, 0.2)';
                activeBox.style.left = param.point.x + 'px';
                activeBox.style.top = param.point.y + 'px';
                activeBox.style.width = '0px';
                activeBox.style.height = '0px';
                overlay.appendChild(activeBox);

            } else {
                // End Drawing
                startPoint = null;
                activeBox = null;
                toggleRectTool();
            }
        });

        chartContainer.addEventListener('mousemove', (e) => {
            if (startPoint && activeBox) {
                const rect = chartContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const width = x - startPoint.x;
                const height = y - startPoint.y;

                activeBox.style.width = Math.abs(width) + 'px';
                activeBox.style.height = Math.abs(height) + 'px';
                activeBox.style.left = (width < 0 ? x : startPoint.x) + 'px';
                activeBox.style.top = (height < 0 ? y : startPoint.y) + 'px';
            }
        });

        function clearRects() {
            overlay.innerHTML = '';
        }

        window.addEventListener('resize', () => {
            chart.applyOptions({ width: window.innerWidth, height: window.innerHeight - 60 });
        });
    </script>
</body>

</html>