<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ES Chart Pro (v5.0)</title>
    <!-- Import Map for ES6 Module Plugins -->
    <script type="importmap">
    {
        "imports": {
            "lightweight-charts": "https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.mjs"
        }
    }
    </script>
    <!-- Lightweight Charts v5.0 - ES Module with global exposure -->
    <script type="module">
        import * as LightweightCharts from 'lightweight-charts';
        window.LightweightCharts = LightweightCharts;
        window.dispatchEvent(new Event('lightweightChartsReady'));
    </script>
    <script src="indicator_manager.js"></script>
    <script src="trendline_plugin.js"></script>
    <script src="rectangle_plugin.js"></script>
    <script src="fibonacci_plugin.js"></script>
    <script src="vertical_line_plugin.js"></script>
    <script src="anchored_text_plugin.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/toolbar.css">
    </style>
</head>

<body>
    <div id="header">
        <div class="toolbar-group">
            <!-- Ticker -->
            <select id="ticker">
                <option value="ES1" selected>ES1</option>
                <option value="NQ1">NQ1</option>
            </select>

            <div class="divider"></div>

            <!-- Timeframe Buttons -->
            <div id="tf-buttons" style="display: flex; gap: 2px;">
                <button onclick="changeTimeframe('1m')" data-tf="1m">1m</button>
                <button onclick="changeTimeframe('5m')" data-tf="5m">5m</button>
                <button onclick="changeTimeframe('15m')" data-tf="15m">15m</button>
                <button onclick="changeTimeframe('1h')" class="active" data-tf="1h">1h</button>
                <button onclick="changeTimeframe('4h')" data-tf="4h">4h</button>
                <button onclick="changeTimeframe('1D')" data-tf="1D">1D</button>
            </div>

            <!-- Custom Timeframe -->
            <input type="text" id="custom-tf" placeholder="Custom" style="width: 60px; text-align: center;"
                onchange="changeTimeframe(this.value)" title="Enter custom timeframe (e.g. 45m, 2D)">

            <!-- More Timeframes Dropdown -->
            <select id="more-timeframes" onchange="changeTimeframe(this.value)" style="width: 20px; padding: 0;"
                title="More Timeframes">
                <option value="" disabled selected>‚ñº</option>
                <!-- Populated by JS -->
            </select>

            <div class="divider"></div>

            <!-- Drawing Tools -->
            <button id="btn-line" onclick="setTool('line')" title="Draw Price Line">üìè Line</button>
            <button id="btn-ray" onclick="setTool('ray')" title="Draw Trend Line">üìâ Trend</button>
            <button id="btn-rect" onclick="setTool('rect')" title="Draw Rectangle">‚ñ≠ Rect</button>
            <button id="btn-fib" onclick="setTool('fib')" title="Draw Fibonacci">üî¢ Fib</button>
            <button id="btn-vert" onclick="setTool('vert')" title="Draw Vertical Line">‚îÇ Vert</button>
            <button id="btn-text" onclick="addWatermark()" title="Add Watermark">T Text</button>
            <button onclick="clearDrawings()" title="Clear All Drawings">üóë</button>

            <div class="divider"></div>

            <!-- Enhanced Plugins Menu -->
            <div class="menu-dropdown">
                <button>üß© Plugins</button>
                <div class="menu-content">
                    <div class="menu-category">Tooltips</div>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('tooltip', 'Tooltip', 'primitive');">Crosshair Tooltip</a>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('delta-tooltip', 'Delta Tooltip', 'primitive');">Delta Tooltip</a>
                    
                    <div class="menu-category">Visual</div>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('volume-profile', 'Volume Profile', 'primitive');">Volume Profile</a>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('session-highlighting', 'Session Highlighting', 'primitive');">Session Highlighting</a>
                    
                    <div class="menu-category">Drawing Tools</div>
                    
                    <div class="menu-category">Price Lines</div>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('user-price-lines', 'Price Lines', 'primitive');">User Price Lines</a>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('user-price-alerts', 'Price Alerts', 'primitive');">Price Alerts</a>
                </div>
            </div>

            <!-- Enhanced Indicators Menu -->
            <div class="menu-dropdown">
                <button>üìä Plugin Indicators</button>
                <div class="menu-content">
                    <div class="menu-category">Trend</div>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('moving-average', 'Moving Average', 'indicator');">Moving Average</a>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('momentum', 'Momentum', 'indicator');">Momentum</a>
                    
                    <div class="menu-category">Price Analysis</div>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('average-price', 'Average Price', 'indicator');">Average Price</a>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('median-price', 'Median Price', 'indicator');">Median Price</a>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('weighted-close', 'Weighted Close', 'indicator');">Weighted Close</a>
                    
                    <div class="menu-category">Mathematical</div>
                    <a href="#" onclick="event.preventDefault(); loadAndApplyPlugin('percent-change', 'Percent Change', 'indicator');">Percent Change</a>
                </div>
            </div>

            <!-- Indicators & Strategy -->
            <select id="indicatorSelect" onchange="addIndicatorFromMenu(this)">
                <option value="" disabled selected>+ Indicators</option>
                <option value="sma">SMA (20)</option>
                <option value="ema">EMA (50)</option>
                <option value="vwap">VWAP</option>
                <option value="bb">Bollinger Bands</option>
                <option value="rsi">RSI (14)</option>
                <option value="macd">MACD (12, 26, 9)</option>
                <option value="atr">ATR (14)</option>
            </select>
            <button id="strategyBtn" onclick="toggleStrategy()">‚ö° Strategy</button>
        </div>

        <div class="toolbar-group">
            <!-- Navigation -->
            <input type="date" id="datePicker">
            <button onclick="jumpToDate()">Go</button>

            <div class="divider"></div>

            <!-- Timezone -->
            <select id="timezone">
                <option value="America/New_York" selected>NY (EST)</option>
                <option value="America/Chicago">Chicago (CST)</option>
                <option value="America/Los_Angeles">LA (PST)</option>
                <option value="UTC">UTC</option>
                <option value="Europe/London">London</option>
            </select>

            <div class="divider"></div>
            <!-- Plugin Manager -->
        <div id="plugin-manager" style="position: absolute; top: 60px; right: 10px; background: rgba(42, 46, 57, 0.95); border: 1px solid #4a4e59; border-radius: 4px; padding: 10px; width: 250px; max-height: 400px; overflow-y: auto; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #4a4e59; padding-bottom: 8px;">
                <h3 style="margin: 0; font-size: 14px; color: #d1d4dc;">Active Plugins</h3>
                <button onclick="clearAllPlugins()" style="background: #d32f2f; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">Clear All</button>
            </div>
            <div id="plugin-list">
                <div style="color: #888; font-size: 12px; padding: 10px; text-align: center;">No plugins loaded</div>
            </div>
        </div>
        <button id="toggle-plugin-manager" onclick="togglePluginManager()" style="position: absolute; top: 65px; right: 10px; background: #2962FF; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; z-index: 100;">
            üìã Plugins (<span id="plugin-count">0</span>)
        </button>

        <div id="status">Loading...</div>
        </div>
    </div>

    <div id="chart-container" style="display: flex; flex-direction: column; height: calc(100vh - 54px);">
        <div id="chart" style="flex: 1; min-height: 400px;"></div>
        <div id="indicator-container" style="flex: 0 0 auto;"></div>
    </div>

    <!-- Main Application Module -->
    <script type="module" src="js/main.js"></script>
</body>

</html>