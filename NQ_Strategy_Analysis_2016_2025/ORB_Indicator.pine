//@version=5
indicator("9:30 AM Opening Range Breakout", shorttitle="ORB", overlay=true)

// ==================== INPUTS ====================
// Session Settings
sessionStart = input.session("0930-0931", "Opening Range Session (ET)", group="Session")
tradingEnd = input.session("0944-1600", "Trading Window End", group="Session")
useTimeExit = input.bool(true, "Use Time Exit (9:44 AM)", group="Session")

// Strategy Settings
tpMultiplier = input.float(2.0, "Take Profit (R-Multiple)", minval=0.5, maxval=10, step=0.5, group="Strategy")
slThreshold = input.string("0%", "Close Inside Range Exit", options=["Off", "0%", "25%", "50%", "75%"], group="Strategy")
maxRangePct = input.float(0.25, "Max Range % Filter (0=disabled)", minval=0, maxval=1, step=0.05, group="Strategy")

// Line Styling - Entry
showEntryLine = input.bool(true, "Show Entry Line", group="Entry Line")
entryLineColor = input.color(color.blue, "Entry Line Color", group="Entry Line")
entryLineStyle = input.string("Solid", "Entry Line Style", options=["Solid", "Dashed", "Dotted"], group="Entry Line")
entryLineWidth = input.int(2, "Entry Line Width", minval=1, maxval=4, group="Entry Line")

// Line Styling - Stop Loss
showSLLine = input.bool(true, "Show Stop Loss Line", group="Stop Loss Line")
slLineColor = input.color(color.red, "SL Line Color", group="Stop Loss Line")
slLineStyle = input.string("Dashed", "SL Line Style", options=["Solid", "Dashed", "Dotted"], group="Stop Loss Line")
slLineWidth = input.int(2, "SL Line Width", minval=1, maxval=4, group="Stop Loss Line")

// Line Styling - Take Profit
showTPLine = input.bool(true, "Show Take Profit Line", group="Take Profit Line")
tpLineColor = input.color(color.green, "TP Line Color", group="Take Profit Line")
tpLineStyle = input.string("Dashed", "TP Line Style", options=["Solid", "Dashed", "Dotted"], group="Take Profit Line")
tpLineWidth = input.int(2, "TP Line Width", minval=1, maxval=4, group="Take Profit Line")

// Line Styling - Opening Range
showRangeBox = input.bool(true, "Show Opening Range Box", group="Range Box")
rangeBoxColor = input.color(color.new(color.purple, 80), "Range Box Color", group="Range Box")
rangeBorderColor = input.color(color.purple, "Range Border Color", group="Range Box")

// ==================== HELPER FUNCTIONS ====================
getLineStyle(style) =>
    switch style
        "Solid" => line.style_solid
        "Dashed" => line.style_dashed
        "Dotted" => line.style_dotted
        => line.style_solid

// ==================== SESSION DETECTION ====================
isOpeningRangeBar = not na(time(timeframe.period, sessionStart, "America/New_York"))
isTradingWindow = not na(time(timeframe.period, "0931-0944", "America/New_York"))
isPostWindow = not na(time(timeframe.period, "0944-1600", "America/New_York"))

// ==================== OPENING RANGE CALCULATION ====================
var float rangeHigh = na
var float rangeLow = na
var bool rangeDefined = false
var int rangeBarIndex = na

// Detect new day
newDay = dayofweek != dayofweek[1]

if newDay
    rangeHigh := na
    rangeLow := na
    rangeDefined := false
    rangeBarIndex := na

// Capture opening range from 9:30 bar
if isOpeningRangeBar and not rangeDefined
    rangeHigh := high
    rangeLow := low
    rangeDefined := true
    rangeBarIndex := bar_index

// ==================== RANGE FILTER ====================
rangeSize = rangeDefined ? rangeHigh - rangeLow : na
rangePct = rangeDefined ? (rangeSize / close) * 100 : na
rangeValid = maxRangePct == 0 or (rangePct <= maxRangePct)

// ==================== SIGNAL GENERATION ====================
var int tradeDirection = 0  // 0 = none, 1 = long, -1 = short
var bool hasTradedToday = false
var float entryPrice = na
var float slPrice = na
var float tpPrice = na

// Reset on new day
if newDay
    tradeDirection := 0
    hasTradedToday := false
    entryPrice := na
    slPrice := na
    tpPrice := na

// Entry Signals
longSignal = rangeDefined and isTradingWindow and not hasTradedToday and rangeValid and close > rangeHigh
shortSignal = rangeDefined and isTradingWindow and not hasTradedToday and rangeValid and close < rangeLow

if longSignal
    tradeDirection := 1
    hasTradedToday := true
    entryPrice := close
    slPrice := rangeLow
    tpPrice := close + (close - rangeLow) * tpMultiplier

if shortSignal
    tradeDirection := -1
    hasTradedToday := true
    entryPrice := close
    slPrice := rangeHigh
    tpPrice := close - (rangeHigh - close) * tpMultiplier

// ==================== EXIT SIGNALS ====================
// Calculate threshold level for close-inside-range exit
thresholdPct = switch slThreshold
    "0%" => 0.0
    "25%" => 0.25
    "50%" => 0.50
    "75%" => 0.75
    => -1.0  // Off

closeInsideLong = tradeDirection == 1 and thresholdPct >= 0 and close < rangeHigh - (rangeSize * thresholdPct)
closeInsideShort = tradeDirection == -1 and thresholdPct >= 0 and close > rangeLow + (rangeSize * thresholdPct)

// Exit conditions
exitSignal = (tradeDirection == 1 and (close <= slPrice or close >= tpPrice or closeInsideLong)) or
             (tradeDirection == -1 and (close >= slPrice or close <= tpPrice or closeInsideShort))

// Time exit
timeExitSignal = useTimeExit and isPostWindow and tradeDirection != 0

if exitSignal or timeExitSignal
    tradeDirection := 0

// ==================== PLOTTING ====================
// Buy/Sell Signals
plotshape(longSignal, title="Long Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.normal, text="LONG")
plotshape(shortSignal, title="Short Signal", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.normal, text="SHORT")

// Opening Range Box
var box rangeBox = na
if showRangeBox and rangeDefined and rangeBarIndex == bar_index
    rangeBox := box.new(rangeBarIndex, rangeHigh, bar_index + 50, rangeLow, 
                        bgcolor=rangeBoxColor, border_color=rangeBorderColor, border_width=1)

// Extend box on each bar
if showRangeBox and rangeDefined and not na(rangeBox) and isTradingWindow
    box.set_right(rangeBox, bar_index + 1)

// Entry, SL, TP Lines (only when in trade)
var line entryLine = na
var line slLine = na
var line tpLine = na

// Create lines on entry
if longSignal or shortSignal
    if showEntryLine
        entryLine := line.new(bar_index, entryPrice, bar_index + 50, entryPrice, 
                              color=entryLineColor, style=getLineStyle(entryLineStyle), width=entryLineWidth)
    if showSLLine
        slLine := line.new(bar_index, slPrice, bar_index + 50, slPrice, 
                           color=slLineColor, style=getLineStyle(slLineStyle), width=slLineWidth)
    if showTPLine
        tpLine := line.new(bar_index, tpPrice, bar_index + 50, tpPrice, 
                           color=tpLineColor, style=getLineStyle(tpLineStyle), width=tpLineWidth)

// Extend lines while in trade
if tradeDirection != 0
    if not na(entryLine)
        line.set_x2(entryLine, bar_index + 1)
    if not na(slLine)
        line.set_x2(slLine, bar_index + 1)
    if not na(tpLine)
        line.set_x2(tpLine, bar_index + 1)

// ==================== INFO TABLE ====================
var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80))

if barstate.islast and rangeDefined
    table.cell(infoTable, 0, 0, "Range High", text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(rangeHigh, "#.##"), text_color=color.green)
    table.cell(infoTable, 0, 1, "Range Low", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(rangeLow, "#.##"), text_color=color.red)
    table.cell(infoTable, 0, 2, "Range Size", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(rangeSize, "#.##") + " (" + str.tostring(rangePct, "#.###") + "%)", text_color=color.yellow)
    table.cell(infoTable, 0, 3, "Status", text_color=color.white)
    statusText = tradeDirection == 1 ? "LONG" : tradeDirection == -1 ? "SHORT" : rangeValid ? "Waiting" : "SKIP (Range)"
    statusColor = tradeDirection == 1 ? color.green : tradeDirection == -1 ? color.red : rangeValid ? color.gray : color.orange
    table.cell(infoTable, 1, 3, statusText, text_color=statusColor)
    table.cell(infoTable, 0, 4, "Exit Threshold", text_color=color.white)
    table.cell(infoTable, 1, 4, slThreshold, text_color=color.purple)
    table.cell(infoTable, 0, 5, "TP Target", text_color=color.white)
    table.cell(infoTable, 1, 5, str.tostring(tpMultiplier) + "R", text_color=color.blue)

// ==================== ALERTS ====================
alertcondition(longSignal, title="Long Entry", message="9:30 ORB: LONG Signal at {{close}}")
alertcondition(shortSignal, title="Short Entry", message="9:30 ORB: SHORT Signal at {{close}}")
alertcondition(exitSignal, title="Exit Signal", message="9:30 ORB: EXIT Signal")
