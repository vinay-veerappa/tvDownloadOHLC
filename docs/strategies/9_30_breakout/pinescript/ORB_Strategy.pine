//@version=5
strategy("9:30 AM Opening Range Breakout Strategy", shorttitle="ORB Strategy", overlay=true, 
         default_qty_type=strategy.contracts, default_qty_value=1,
         initial_capital=3000, commission_type=strategy.commission.per_contract, commission_value=0.62)

// ==================== INPUTS ====================
// Session Settings
sessionStart = input.session("0930-0931", "Opening Range Session (ET)", group="Session")
useTimeExit = input.bool(true, "Use Time Exit (9:44 AM)", group="Session")

// Strategy Settings
tpMultiplier = input.float(2.0, "Take Profit (R-Multiple)", minval=0.5, maxval=10, step=0.5, group="Strategy")
slThreshold = input.string("0%", "Close Inside Range Exit", options=["Off", "0%", "25%", "50%", "75%"], group="Strategy")
maxRangePct = input.float(0.25, "Max Range % Filter (0=disabled)", minval=0, maxval=1, step=0.05, group="Strategy")

// Position Sizing
usePositionSizing = input.bool(true, "Use Position Sizing", group="Position Sizing")
riskPercent = input.float(2.0, "Risk Per Trade (%)", minval=0.5, maxval=10, step=0.5, group="Position Sizing")
pointValue = input.float(2.0, "Point Value ($)", tooltip="MNQ=$2, NQ=$20", group="Position Sizing")

// Backtest Date Range
startDate = input.time(timestamp("2016-01-01"), "Start Date", group="Backtest Period")
endDate = input.time(timestamp("2025-12-31"), "End Date", group="Backtest Period")

// ==================== SESSION DETECTION ====================
isOpeningRangeBar = not na(time(timeframe.period, sessionStart, "America/New_York"))
isTradingWindow = not na(time(timeframe.period, "0931-0944", "America/New_York"))
isTimeExit = not na(time(timeframe.period, "0944-0945", "America/New_York"))
inDateRange = time >= startDate and time <= endDate

// ==================== OPENING RANGE CALCULATION ====================
var float rangeHigh = na
var float rangeLow = na
var bool rangeDefined = false
var bool hasTradedToday = false

// Detect new day
newDay = dayofweek != dayofweek[1]

if newDay
    rangeHigh := na
    rangeLow := na
    rangeDefined := false
    hasTradedToday := false

// Capture opening range from 9:30 bar
if isOpeningRangeBar and not rangeDefined
    rangeHigh := high
    rangeLow := low
    rangeDefined := true

// ==================== RANGE FILTER ====================
rangeSize = rangeDefined ? rangeHigh - rangeLow : na
rangePct = rangeDefined and close > 0 ? (rangeSize / close) * 100 : na
rangeValid = maxRangePct == 0 or (not na(rangePct) and rangePct <= maxRangePct)

// ==================== POSITION SIZING ====================
calculateContracts() =>
    if usePositionSizing and rangeDefined and rangeSize > 0
        riskAmount = strategy.equity * (riskPercent / 100)
        riskPerContract = rangeSize * pointValue
        math.max(1, math.floor(riskAmount / riskPerContract))
    else
        1

// ==================== ENTRY SIGNALS ====================
longCondition = rangeDefined and isTradingWindow and not hasTradedToday and rangeValid and close > rangeHigh and inDateRange
shortCondition = rangeDefined and isTradingWindow and not hasTradedToday and rangeValid and close < rangeLow and inDateRange

// Entry
if longCondition
    contracts = calculateContracts()
    risk = rangeSize
    tp = close + risk * tpMultiplier
    sl = rangeLow
    strategy.entry("Long", strategy.long, qty=contracts)
    strategy.exit("Long Exit", "Long", limit=tp, stop=sl)
    hasTradedToday := true

if shortCondition
    contracts = calculateContracts()
    risk = rangeSize
    tp = close - risk * tpMultiplier
    sl = rangeHigh
    strategy.entry("Short", strategy.short, qty=contracts)
    strategy.exit("Short Exit", "Short", limit=tp, stop=sl)
    hasTradedToday := true

// ==================== CLOSE INSIDE RANGE EXIT ====================
thresholdPct = switch slThreshold
    "0%" => 0.0
    "25%" => 0.25
    "50%" => 0.50
    "75%" => 0.75
    => -1.0  // Off

// Check for close inside range (early exit)
inLong = strategy.position_size > 0
inShort = strategy.position_size < 0

closeInsideLong = inLong and rangeDefined and thresholdPct >= 0 and close < rangeHigh - (rangeSize * thresholdPct)
closeInsideShort = inShort and rangeDefined and thresholdPct >= 0 and close > rangeLow + (rangeSize * thresholdPct)

if closeInsideLong
    strategy.close("Long", comment="Close Inside Range")

if closeInsideShort
    strategy.close("Short", comment="Close Inside Range")

// ==================== TIME EXIT ====================
if useTimeExit and isTimeExit
    if inLong
        strategy.close("Long", comment="Time Exit")
    if inShort
        strategy.close("Short", comment="Time Exit")

// ==================== PLOTTING ====================
// Opening Range
plot(rangeDefined ? rangeHigh : na, "Range High", color=color.green, style=plot.style_linebr, linewidth=2)
plot(rangeDefined ? rangeLow : na, "Range Low", color=color.red, style=plot.style_linebr, linewidth=2)

// Fill between range
fill(plot(rangeDefined ? rangeHigh : na, display=display.none), 
     plot(rangeDefined ? rangeLow : na, display=display.none), 
     color=color.new(color.purple, 90))

// Entry Signals
plotshape(longCondition, title="Long", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.normal)
plotshape(shortCondition, title="Short", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.normal)

// ==================== INFO TABLE ====================
var table statsTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80))

if barstate.islast
    // Calculate stats
    winRate = strategy.wintrades / (strategy.wintrades + strategy.losstrades) * 100
    profitFactor = strategy.grossprofit / math.max(1, strategy.grossloss)
    
    table.cell(statsTable, 0, 0, "Net Profit", text_color=color.white)
    table.cell(statsTable, 1, 0, "$" + str.tostring(strategy.netprofit, "#.##"), text_color=strategy.netprofit >= 0 ? color.green : color.red)
    table.cell(statsTable, 0, 1, "Win Rate", text_color=color.white)
    table.cell(statsTable, 1, 1, str.tostring(winRate, "#.#") + "%", text_color=winRate >= 40 ? color.green : color.yellow)
    table.cell(statsTable, 0, 2, "Profit Factor", text_color=color.white)
    table.cell(statsTable, 1, 2, str.tostring(profitFactor, "#.##"), text_color=profitFactor >= 1.5 ? color.green : color.yellow)
    table.cell(statsTable, 0, 3, "Total Trades", text_color=color.white)
    table.cell(statsTable, 1, 3, str.tostring(strategy.closedtrades), text_color=color.white)
    table.cell(statsTable, 0, 4, "Max Drawdown", text_color=color.white)
    table.cell(statsTable, 1, 4, "$" + str.tostring(strategy.max_drawdown, "#.##"), text_color=color.orange)
    table.cell(statsTable, 0, 5, "Range Filter", text_color=color.white)
    table.cell(statsTable, 1, 5, maxRangePct == 0 ? "Off" : str.tostring(maxRangePct) + "%", text_color=color.purple)
    table.cell(statsTable, 0, 6, "Exit Threshold", text_color=color.white)
    table.cell(statsTable, 1, 6, slThreshold, text_color=color.purple)
    table.cell(statsTable, 0, 7, "TP Target", text_color=color.white)
    table.cell(statsTable, 1, 7, str.tostring(tpMultiplier) + "R", text_color=color.blue)
