# Derived Data Documentation

**Version:** 1.0.0
**Last Updated:** December 26, 2025

This document describes all derived/precomputed data files generated from raw OHLC data, their contents, and storage locations.

> [!TIP]
> To regenerate all derived data for a ticker, run: `python scripts/derived/regenerate_derived.py <TICKER>`

---

## 1. Overview

Derived data is precomputed from raw parquet OHLC data to support charting features, analytics, and research. These files are regenerated whenever source data is updated.

| Category | Files | Location | Script |
|:---|:---|:---|:---|
| Profiler Stats | `{ticker}_profiler.json` | `data/` | `precompute_profiler.py` |
| Daily HOD/LOD | `{ticker}_daily_hod_lod.json` | `data/` | `precompute_daily_hod_lod.py` |
| Session HOD/LOD | `{ticker}_hod_lod.json` | `data/` | `precompute_hod_lod.py` |
| Level Touches | `{ticker}_level_touches.json` | `data/` | `precompute_level_touches.py` |
| Range Distribution | `{ticker}_range_dist.json` | `data/` | `precompute_range_dist.py` |
| Sessions | `{ticker}_sessions.json` | `data/sessions/` | `precompute_sessions.py` |
| VWAP Indicators | `{ticker}_1m_vwap.parquet` | `data/indicators/` | `precompute_vwap.py` |
| Live Charts | `live_chart_{symbol}.json` | `data/` | Schwab Streamer |

---

## 2. File Descriptions

### 2.1 Profiler Stats (`{ticker}_profiler.json`)

**Purpose:** Session-by-session trading statistics for the Profiler feature.

**Contents (per record):**
```json
{
  "date": "2025-12-20",
  "session": "NY1",           // NY1, NY2, ON, etc.
  "open": 6050.25,
  "prior_close": 6048.50,
  "range_high": 6075.00,
  "range_low": 6042.25,
  "high_ts": 1734710400,      // Unix timestamp of session high
  "low_ts": 1734720000,       // Unix timestamp of session low
  "status_ts": 1734723600,    // Status determination timestamp
  "daily_open": 6050.00,
  "daily_high": 6080.00,
  "daily_low": 6040.00
}
```

**Generated By:** `scripts/derived/precompute_profiler.py`

**Available For:** ES1, NQ1, CL1, GC1, RTY1, YM1, SPX, VIX, VVIX

---

### 2.2 Daily HOD/LOD (`{ticker}_daily_hod_lod.json`)

**Purpose:** Daily high/low of day statistics for scatter plots and analysis.

**Contents (per record):**
```json
{
  "date": "2025-12-20",
  "daily_high": 6080.00,
  "daily_low": 6040.00,
  "daily_open": 6050.00,
  "daily_close": 6070.00,
  "high_time": "10:35",       // Time of HOD (NY time)
  "low_time": "14:22",        // Time of LOD (NY time)
  "high_ts": 1734710100,
  "low_ts": 1734723720
}
```

**Generated By:** `scripts/derived/precompute_daily_hod_lod.py`

**Available For:** ES1, NQ1, CL1, GC1, RTY1, YM1, SPX, VIX, VVIX

---

### 2.3 Session HOD/LOD (`{ticker}_hod_lod.json`)

**Purpose:** Per-session (not daily) high/low statistics.

**Structure:** Similar to daily HOD/LOD but segmented by trading session.

**Generated By:** `scripts/derived/precompute_hod_lod.py`

---

### 2.4 Level Touches (`{ticker}_level_touches.json`)

**Purpose:** Records every time price touches or crosses key levels (Prior day high/low, overnight high/low, IB range, etc.).

**Contents (per record):**
```json
{
  "date": "2025-12-20",
  "level_type": "PDH",        // PDH, PDL, ONH, ONL, IBH, IBL, etc.
  "level_price": 6080.00,
  "touch_time": "09:45",
  "touch_ts": 1734707100,
  "direction": "from_below", // from_below, from_above
  "break": true              // Did it break through?
}
```

**Generated By:** `scripts/derived/precompute_level_touches.py`

**Available For:** ES1, NQ1, CL1, GC1, RTY1, YM1, SPX, VIX, VVIX

---

### 2.5 Range Distribution (`{ticker}_range_dist.json`)

**Purpose:** Statistical distribution of price ranges by session and time.

**Generated By:** `scripts/derived/precompute_range_dist.py`

---

### 2.6 Sessions (`data/sessions/{ticker}_sessions.json`)

**Purpose:** Precomputed session boundaries and OHLC for each trading session.

**Companion Files:**
- `{ticker}_hourly.parquet` - Hourly aggregated OHLC data

**Generated By:** `scripts/derived/precompute_sessions.py`

---

### 2.7 VWAP Indicators (`data/indicators/{ticker}_1m_vwap.parquet`)

**Purpose:** Precomputed VWAP and standard deviation bands at 1-minute resolution.

**Columns:**
- `time` - Unix timestamp
- `vwap` - Volume-weighted average price
- `vwap_upper_1`, `vwap_lower_1` - ±1 std dev bands
- `vwap_upper_2`, `vwap_lower_2` - ±2 std dev bands

**Generated By:** `scripts/derived/precompute_vwap.py`

**Available For:** ES1, NQ1, CL1, GC1, RTY1, YM1, SPX, VIX, VVIX, QQQ

---

### 2.8 Live Chart Data (`data/live_chart_{symbol}.json`)

**Purpose:** Real-time OHLC data from Schwab API streamer for live charting.

**Variants:**
- `live_chart_{symbol}.json` - 1-minute bars
- `live_chart_{symbol}_15s.json` - 15-second bars
- `live_chart_{symbol}_30s.json` - 30-second bars

**Generated By:** Schwab Streamer Service (`web/app/api/schwab/`)

---

## 3. Master Regeneration

To regenerate all derived data for a specific ticker:

```powershell
python scripts/derived/regenerate_derived.py ES1
```

This runs the following scripts in order:
1. `precompute_profiler.py`
2. `precompute_daily_hod_lod.py`
3. `precompute_hod_lod.py`
4. `precompute_level_touches.py`
5. `precompute_range_dist.py`
6. `precompute_sessions.py`
7. `precompute_vwap.py`

---

## 4. File Sizes

| Ticker | profiler | daily_hod_lod | level_touches | sessions | vwap |
|:---|:---|:---|:---|:---|:---|
| ES1 | 14 MB | 1.2 MB | 36 MB | 8.8 MB | 388 MB |
| NQ1 | 14 MB | 1.2 MB | 29 MB | 8.9 MB | 369 MB |
| CL1 | 14 MB | 1.2 MB | 27 MB | 8.4 MB | 376 MB |
| GC1 | 14 MB | 1.2 MB | 26 MB | 8.7 MB | 385 MB |
| YM1 | 14 MB | 1.2 MB | 28 MB | 8.8 MB | 369 MB |
| RTY1 | 6.8 MB | 0.6 MB | 12 MB | 4.1 MB | 174 MB |

---

## 5. Dependencies

```
scripts/derived/
├── regenerate_derived.py      # Master script
├── precompute_profiler.py     # Profiler stats
├── precompute_daily_hod_lod.py # Daily HOD/LOD
├── precompute_hod_lod.py      # Session HOD/LOD  
├── precompute_level_touches.py # Level touch events
├── precompute_range_dist.py   # Range distributions
├── precompute_sessions.py     # Session boundaries
├── precompute_vwap.py         # VWAP indicators
└── generate_sessions.py       # Session definition helper
```

---

## 6. Prisma Database (`web/prisma/dev.db`)

SQLite database storing application state, journal entries, expected moves, and API data.

**Location:** `web/prisma/dev.db`
**Schema:** `web/prisma/schema.prisma`

### 6.1 Table Overview

| Category | Table | Purpose |
|:---|:---|:---|
| **Journal** | `Account` | Trading accounts with balances |
| | `Strategy` | Trading strategies (with color tags) |
| | `Trade` | Trade records with PnL, MAE, MFE |
| | `Journal` | Daily journal entries |
| | `Tag`, `TagGroup` | Multi-category trade tagging |
| | `Note` | Trade/daily/misc notes |
| | `TradePlan` | Pre-trade planning |
| | `MarketCondition` | VIX, ATR, trend at trade time |
| **Market Data** | `EconomicEvent` | Economic calendar (FOMC, Jobs, etc.) |
| | `ExpectedMove` | Current expected move calculations |
| | `ExpectedMoveHistory` | Historical EM with straddle/IV |
| | `RthExpectedMove` | RTH-specific EM calculations |
| | `HistoricalVolatility` | IV/HV history by ticker |
| | `MarketNews` | Yahoo Finance news feed |
| **UI State** | `WatchlistGroup`, `WatchlistItem` | Symbol watchlists |
| | `BacktestResult` | Stored backtest runs |
| **API** | `SchwabToken` | Schwab OAuth tokens |

---

### 6.2 Key Tables

#### Trade

Core trade journaling table.

| Field | Type | Description |
|:---|:---|:---|
| `id` | String | CUID primary key |
| `ticker` | String | Symbol (e.g. "ES1", "NQ1") |
| `entryDate`, `exitDate` | DateTime | Trade timestamps |
| `entryPrice`, `exitPrice` | Float | Trade prices |
| `quantity` | Float | Position size |
| `direction` | String | "LONG" or "SHORT" |
| `status` | String | "OPEN", "CLOSED", "PENDING", "CANCELLED" |
| `pnl`, `fees` | Float | Realized P&L and fees |
| `risk`, `mae`, `mfe` | Float | Risk metrics |
| `stopLoss`, `takeProfit` | Float | Bracket order levels |
| `notes`, `metadata` | String | Free text and JSON storage |

#### ExpectedMoveHistory

Historical expected move data by ticker and date.

| Field | Type | Description |
|:---|:---|:---|
| `ticker` | String | Symbol |
| `date` | DateTime | Trade date |
| `closePrice` | Float | Close price |
| `straddlePrice`, `emStraddle` | Float | Straddle-based EM |
| `iv365`, `em365` | Float | 365-day IV method |
| `iv252`, `em252` | Float | 252-day IV method |
| `source` | String | "historical", "manual", "computed" |

#### HistoricalVolatility

IV/HV timeseries for analysis.

| Field | Type | Description |
|:---|:---|:---|
| `ticker` | String | Symbol |
| `date` | DateTime | Date |
| `iv` | Float | Implied Volatility |
| `hv` | Float | Historical Volatility |
| `closePrice` | Float | Underlying close |

#### EconomicEvent

Economic calendar events.

| Field | Type | Description |
|:---|:---|:---|
| `datetime` | DateTime | Event time |
| `name` | String | Event name (e.g. "FOMC Rate Decision") |
| `impact` | String | "HIGH", "MEDIUM", "LOW" |
| `actual`, `forecast`, `previous` | Float | Event values |

---

### 6.3 Database Commands

**View in Prisma Studio:**
```powershell
cd web && npx prisma studio
```

**Generate client after schema changes:**
```powershell
cd web && npx prisma generate
```

**Run migrations:**
```powershell
cd web && npx prisma migrate dev
```

**Reset database:**
```powershell
cd web && npx prisma migrate reset
```

